<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VueRouter | AlexTao çš„ åšå®¢</title>
    <meta name="description" content="In doing we learn.">
    <link rel="icon" href="favicon.ico">
    
    <link rel="preload" href="/Weblog/assets/css/styles.05873600.css" as="style"><link rel="preload" href="/Weblog/assets/js/app.05873600.js" as="script"><link rel="preload" href="/Weblog/assets/js/11.d51cd775.js" as="script"><link rel="prefetch" href="/Weblog/assets/css/16.styles.2339a627.css"><link rel="prefetch" href="/Weblog/assets/css/5.styles.c1152841.css"><link rel="prefetch" href="/Weblog/assets/css/7.styles.1f4a6057.css"><link rel="prefetch" href="/Weblog/assets/css/8.styles.5b6e1357.css"><link rel="prefetch" href="/Weblog/assets/js/0.a8dcd889.js"><link rel="prefetch" href="/Weblog/assets/js/10.fe0f74e6.js"><link rel="prefetch" href="/Weblog/assets/js/12.01521323.js"><link rel="prefetch" href="/Weblog/assets/js/13.82c3fc4a.js"><link rel="prefetch" href="/Weblog/assets/js/14.3b16e4be.js"><link rel="prefetch" href="/Weblog/assets/js/15.abf2374c.js"><link rel="prefetch" href="/Weblog/assets/js/16.2339a627.js"><link rel="prefetch" href="/Weblog/assets/js/17.f68b5694.js"><link rel="prefetch" href="/Weblog/assets/js/18.1dc877c8.js"><link rel="prefetch" href="/Weblog/assets/js/19.8d3a8eb9.js"><link rel="prefetch" href="/Weblog/assets/js/2.af3ad6a4.js"><link rel="prefetch" href="/Weblog/assets/js/20.b49a1359.js"><link rel="prefetch" href="/Weblog/assets/js/21.791ceaa2.js"><link rel="prefetch" href="/Weblog/assets/js/22.fc4cbaec.js"><link rel="prefetch" href="/Weblog/assets/js/23.4ad12214.js"><link rel="prefetch" href="/Weblog/assets/js/24.55bc5812.js"><link rel="prefetch" href="/Weblog/assets/js/25.f985eed7.js"><link rel="prefetch" href="/Weblog/assets/js/26.4cb7663f.js"><link rel="prefetch" href="/Weblog/assets/js/27.a14669b1.js"><link rel="prefetch" href="/Weblog/assets/js/28.8620d72f.js"><link rel="prefetch" href="/Weblog/assets/js/29.d0f2b69c.js"><link rel="prefetch" href="/Weblog/assets/js/3.fb06d288.js"><link rel="prefetch" href="/Weblog/assets/js/30.779bb068.js"><link rel="prefetch" href="/Weblog/assets/js/31.40c7de84.js"><link rel="prefetch" href="/Weblog/assets/js/32.ba7c27f0.js"><link rel="prefetch" href="/Weblog/assets/js/33.6ab2c1a8.js"><link rel="prefetch" href="/Weblog/assets/js/34.e8c873d7.js"><link rel="prefetch" href="/Weblog/assets/js/35.e96a75ad.js"><link rel="prefetch" href="/Weblog/assets/js/36.86fbcd91.js"><link rel="prefetch" href="/Weblog/assets/js/37.b26a2882.js"><link rel="prefetch" href="/Weblog/assets/js/38.992c347d.js"><link rel="prefetch" href="/Weblog/assets/js/39.e58d8f81.js"><link rel="prefetch" href="/Weblog/assets/js/4.b91b4b8a.js"><link rel="prefetch" href="/Weblog/assets/js/40.01c8b7bc.js"><link rel="prefetch" href="/Weblog/assets/js/41.75147100.js"><link rel="prefetch" href="/Weblog/assets/js/42.b2377431.js"><link rel="prefetch" href="/Weblog/assets/js/43.3a184450.js"><link rel="prefetch" href="/Weblog/assets/js/44.067bcf22.js"><link rel="prefetch" href="/Weblog/assets/js/45.68ba4476.js"><link rel="prefetch" href="/Weblog/assets/js/46.78e6e5f5.js"><link rel="prefetch" href="/Weblog/assets/js/47.08c79ff4.js"><link rel="prefetch" href="/Weblog/assets/js/48.24964852.js"><link rel="prefetch" href="/Weblog/assets/js/49.e7608465.js"><link rel="prefetch" href="/Weblog/assets/js/5.c1152841.js"><link rel="prefetch" href="/Weblog/assets/js/50.35c99ad9.js"><link rel="prefetch" href="/Weblog/assets/js/51.6b5dac05.js"><link rel="prefetch" href="/Weblog/assets/js/52.c4bb9237.js"><link rel="prefetch" href="/Weblog/assets/js/53.e53dd56d.js"><link rel="prefetch" href="/Weblog/assets/js/54.b8170212.js"><link rel="prefetch" href="/Weblog/assets/js/55.3f8a7f90.js"><link rel="prefetch" href="/Weblog/assets/js/56.70171628.js"><link rel="prefetch" href="/Weblog/assets/js/57.bfaf61b1.js"><link rel="prefetch" href="/Weblog/assets/js/58.db4b1b8a.js"><link rel="prefetch" href="/Weblog/assets/js/59.77684353.js"><link rel="prefetch" href="/Weblog/assets/js/6.829d0e7e.js"><link rel="prefetch" href="/Weblog/assets/js/60.6e9d6cac.js"><link rel="prefetch" href="/Weblog/assets/js/61.275c3154.js"><link rel="prefetch" href="/Weblog/assets/js/62.dd80ea43.js"><link rel="prefetch" href="/Weblog/assets/js/63.dbe8bf46.js"><link rel="prefetch" href="/Weblog/assets/js/64.14e4d91c.js"><link rel="prefetch" href="/Weblog/assets/js/65.c15a382b.js"><link rel="prefetch" href="/Weblog/assets/js/66.1eb3e94c.js"><link rel="prefetch" href="/Weblog/assets/js/67.3ae69c25.js"><link rel="prefetch" href="/Weblog/assets/js/68.2e02b211.js"><link rel="prefetch" href="/Weblog/assets/js/69.2016bf42.js"><link rel="prefetch" href="/Weblog/assets/js/7.1f4a6057.js"><link rel="prefetch" href="/Weblog/assets/js/70.8e2ebe5b.js"><link rel="prefetch" href="/Weblog/assets/js/8.5b6e1357.js"><link rel="prefetch" href="/Weblog/assets/js/9.93970f24.js">
    <link rel="stylesheet" href="/Weblog/assets/css/styles.05873600.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/Weblog/" class="home-link router-link-active"><!----><span class="site-name">
      AlexTao çš„ åšå®¢
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/Weblog/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Classify</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/Weblog/html_css/" class="nav-link">HTML/CSS</a></li><li class="dropdown-item"><!----><a href="/Weblog/javascript/" class="nav-link">Javascript</a></li><li class="dropdown-item"><!----><a href="/Weblog/node/" class="nav-link">Node.js</a></li><li class="dropdown-item"><!----><a href="/Weblog/frames/" class="nav-link router-link-active">Frames</a></li><li class="dropdown-item"><!----><a href="/Weblog/tool/" class="nav-link">Tool</a></li><li class="dropdown-item"><!----><a href="/Weblog/currency/" class="nav-link">Currency</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/AlexTaoClub" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Weblog/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Classify</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/Weblog/html_css/" class="nav-link">HTML/CSS</a></li><li class="dropdown-item"><!----><a href="/Weblog/javascript/" class="nav-link">Javascript</a></li><li class="dropdown-item"><!----><a href="/Weblog/node/" class="nav-link">Node.js</a></li><li class="dropdown-item"><!----><a href="/Weblog/frames/" class="nav-link router-link-active">Frames</a></li><li class="dropdown-item"><!----><a href="/Weblog/tool/" class="nav-link">Tool</a></li><li class="dropdown-item"><!----><a href="/Weblog/currency/" class="nav-link">Currency</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/AlexTaoClub" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>Vue</span><span class="arrow down"></span></p><ul class="sidebar-group-items"><li><a href="/Weblog/frames/vue/" aria-current="page" class="sidebar-link">æ•°æ®åŸç†</a></li><li><a href="/Weblog/frames/vue/ç”Ÿå‘½å‘¨æœŸ.html" class="sidebar-link">ç”Ÿå‘½å‘¨æœŸ</a></li><li><a href="/Weblog/frames/vue/template.html" class="sidebar-link">templateç†è§£</a></li><li><a href="/Weblog/frames/vue/NextTick.html" class="sidebar-link">NextTick</a></li><li><a href="/Weblog/frames/vue/VueRouter.html" aria-current="page" class="active sidebar-link">VueRouter</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Weblog/frames/vue/VueRouter.html#è·¯ç”±æ³¨å†Œ" class="sidebar-link">è·¯ç”±æ³¨å†Œ</a></li><li class="sidebar-sub-header"><a href="/Weblog/frames/vue/VueRouter.html#vuerouterå®ä¾‹åŒ–" class="sidebar-link">VueRouterå®ä¾‹åŒ–</a></li><li class="sidebar-sub-header"><a href="/Weblog/frames/vue/VueRouter.html#åˆ›å»ºè·¯ç”±åŒ¹é…å¯¹è±¡" class="sidebar-link">åˆ›å»ºè·¯ç”±åŒ¹é…å¯¹è±¡</a></li><li class="sidebar-sub-header"><a href="/Weblog/frames/vue/VueRouter.html#è·¯ç”±åˆå§‹åŒ–" class="sidebar-link">è·¯ç”±åˆå§‹åŒ–</a></li><li class="sidebar-sub-header"><a href="/Weblog/frames/vue/VueRouter.html#è·¯ç”±è·³è½¬" class="sidebar-link">è·¯ç”±è·³è½¬</a></li></ul></li><li><a href="/Weblog/frames/vue/ç™»å½•æ‹¦æˆªé€»è¾‘.html" class="sidebar-link">ç™»å½•æ‹¦æˆªé€»è¾‘</a></li><li><a href="/Weblog/frames/vue/è·¯ç”±è·³è½¬ä¼ å‚.html" class="sidebar-link">è·¯ç”±è·³è½¬ä¼ å‚</a></li><li><a href="/Weblog/frames/vue/ç»„ä»¶é€šä¿¡.html" class="sidebar-link">ç»„ä»¶é€šä¿¡ </a></li><li><a href="/Weblog/frames/vue/çˆ¶å­ç»„ä»¶æ•°æ®åŒå‘ç»‘å®š.html" class="sidebar-link">çˆ¶å­ç»„ä»¶æ•°æ®åŒå‘ç»‘å®š</a></li><li><a href="/Weblog/frames/vue/VUEX.html" class="sidebar-link">VUEX</a></li><li><a href="/Weblog/frames/vue/vue-property-decorator.html" class="sidebar-link">vue-property-decorator</a></li><li><a href="/Weblog/frames/vue/TslintOfVue.html" class="sidebar-link">Tslint.jsoné…ç½®</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>React</span><span class="arrow right"></span></p><!----></div></li></ul></div><div class="page"><div class="content"><h1 id="vuerouter">VueRouter</h1><h3 id="é‡è¦å‡½æ•°æ€ç»´å¯¼å›¾">é‡è¦å‡½æ•°æ€ç»´å¯¼å›¾</h3><p>ä»¥ä¸‹æ€ç»´å¯¼å›¾ç½—åˆ—äº†æºç ä¸­é‡è¦çš„ä¸€äº›å‡½æ•° <img src="/Weblog/assets/img/vue_02.5b4ddc25.png" alt="img"></p><h2 id="è·¯ç”±æ³¨å†Œ">è·¯ç”±æ³¨å†Œ</h2><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæ¨èå¤§å®¶ clone ä¸€ä»½æºç å¯¹ç…§ç€çœ‹ã€‚å› ä¸ºç¯‡å¹…è¾ƒé•¿ï¼Œå‡½æ•°é—´çš„è·³è½¬ä¹Ÿå¾ˆå¤šã€‚</p><p>ä½¿ç”¨è·¯ç”±ä¹‹å‰ï¼Œéœ€è¦è°ƒç”¨ <code>Vue.use(VueRouter)</code>ï¼Œè¿™æ˜¯å› ä¸ºè®©æ’ä»¶å¯ä»¥ä½¿ç”¨ Vue</p><div class="language- extra-class"><pre class="language-text"><code>export function initUse (Vue: GlobalAPI) {
  Vue.use = function (plugin: Function | Object) {
    // åˆ¤æ–­é‡å¤å®‰è£…æ’ä»¶
    const installedPlugins = (this._installedPlugins || (this._installedPlugins = []))
    if (installedPlugins.indexOf(plugin) &gt; -1) {
      return this
    }
    const args = toArray(arguments, 1)
    // æ’å…¥ Vue
    args.unshift(this)
    // ä¸€èˆ¬æ’ä»¶éƒ½ä¼šæœ‰ä¸€ä¸ª install å‡½æ•°
    // é€šè¿‡è¯¥å‡½æ•°è®©æ’ä»¶å¯ä»¥ä½¿ç”¨ Vue
    if (typeof plugin.install === 'function') {
      plugin.install.apply(plugin, args)
    } else if (typeof plugin === 'function') {
      plugin.apply(null, args)
    }
    installedPlugins.push(plugin)
    return this
  }
}
</code></pre></div><p>æ¥ä¸‹æ¥çœ‹ä¸‹ <code>install</code> å‡½æ•°çš„éƒ¨åˆ†å®ç°</p><div class="language- extra-class"><pre class="language-text"><code>export function install (Vue) {
  // ç¡®ä¿ install è°ƒç”¨ä¸€æ¬¡
  if (install.installed &amp;&amp; _Vue === Vue) return
  install.installed = true
  // æŠŠ Vue èµ‹å€¼ç»™å…¨å±€å˜é‡
  _Vue = Vue
  const registerInstance = (vm, callVal) =&gt; {
    let i = vm.$options._parentVnode
    if (isDef(i) &amp;&amp; isDef(i = i.data) &amp;&amp; isDef(i = i.registerRouteInstance)) {
      i(vm, callVal)
    }
  }
  // ç»™æ¯ä¸ªç»„ä»¶çš„é’©å­å‡½æ•°æ··å…¥å®ç°
  // å¯ä»¥å‘ç°åœ¨ `beforeCreate` é’©å­æ‰§è¡Œæ—¶
  // ä¼šåˆå§‹åŒ–è·¯ç”±
  Vue.mixin({
    beforeCreate () {
      // åˆ¤æ–­ç»„ä»¶æ˜¯å¦å­˜åœ¨ router å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åªåœ¨æ ¹ç»„ä»¶ä¸Šæœ‰
      if (isDef(this.$options.router)) {
        // æ ¹è·¯ç”±è®¾ç½®ä¸ºè‡ªå·±
        this._routerRoot = this
        this._router = this.$options.router
        // åˆå§‹åŒ–è·¯ç”±
        this._router.init(this)
        // å¾ˆé‡è¦ï¼Œä¸º _route å±æ€§å®ç°åŒå‘ç»‘å®š
        // è§¦å‘ç»„ä»¶æ¸²æŸ“
        Vue.util.defineReactive(this, '_route', this._router.history.current)
      } else {
        // ç”¨äº router-view å±‚çº§åˆ¤æ–­
        this._routerRoot = (this.$parent &amp;&amp; this.$parent._routerRoot) || this
      }
      registerInstance(this, this)
    },
    destroyed () {
      registerInstance(this)
    }
  })
  // å…¨å±€æ³¨å†Œç»„ä»¶ router-link å’Œ router-view
  Vue.component('RouterView', View)
  Vue.component('RouterLink', Link)
}
</code></pre></div><p>å¯¹äºè·¯ç”±æ³¨å†Œæ¥è¯´ï¼Œæ ¸å¿ƒå°±æ˜¯è°ƒç”¨ <code>Vue.use(VueRouter)</code>ï¼Œä½¿å¾— VueRouter å¯ä»¥ä½¿ç”¨ Vueã€‚ç„¶åé€šè¿‡ Vue æ¥è°ƒç”¨ VueRouter çš„ <code>install</code> å‡½æ•°ã€‚åœ¨è¯¥å‡½æ•°ä¸­ï¼Œæ ¸å¿ƒå°±æ˜¯ç»™ç»„ä»¶æ··å…¥é’©å­å‡½æ•°å’Œå…¨å±€æ³¨å†Œä¸¤ä¸ªè·¯ç”±ç»„ä»¶ã€‚</p><h2 id="vuerouterå®ä¾‹åŒ–">VueRouterå®ä¾‹åŒ–</h2><p>åœ¨å®‰è£…æ’ä»¶åï¼Œå¯¹ VueRouter è¿›è¡Œå®ä¾‹åŒ–ã€‚</p><div class="language- extra-class"><pre class="language-text"><code>const Home = { template: '&lt;div&gt;home&lt;/div&gt;' }
const Foo = { template: '&lt;div&gt;foo&lt;/div&gt;' }
const Bar = { template: '&lt;div&gt;bar&lt;/div&gt;' }

// 3. Create the router
const router = new VueRouter({
  mode: 'hash',
  base: __dirname,
  routes: [
    { path: '/', component: Home }, // all paths are defined without the hash.
    { path: '/foo', component: Foo },
    { path: '/bar', component: Bar }
  ]
})
</code></pre></div><p>æ¥çœ‹ä¸€ä¸‹ VueRouter çš„æ„é€ å‡½æ•°</p><div class="language- extra-class"><pre class="language-text"><code>constructor(options: RouterOptions = {}) {
    // ...
    // è·¯ç”±åŒ¹é…å¯¹è±¡
    this.matcher = createMatcher(options.routes || [], this)

    // æ ¹æ® mode é‡‡å–ä¸åŒçš„è·¯ç”±æ–¹å¼
    let mode = options.mode || 'hash'
    this.fallback =
      mode === 'history' &amp;&amp; !supportsPushState &amp;&amp; options.fallback !== false
    if (this.fallback) {
      mode = 'hash'
    }
    if (!inBrowser) {
      mode = 'abstract'
    }
    this.mode = mode

    switch (mode) {
      case 'history':
        this.history = new HTML5History(this, options.base)
        break
      case 'hash':
        this.history = new HashHistory(this, options.base, this.fallback)
        break
      case 'abstract':
        this.history = new AbstractHistory(this, options.base)
        break
      default:
        if (process.env.NODE_ENV !== 'production') {
          assert(false, `invalid mode: ${mode}`)
        }
    }
  }
</code></pre></div><p>åœ¨å®ä¾‹åŒ– VueRouter çš„è¿‡ç¨‹ä¸­ï¼Œæ ¸å¿ƒæ˜¯åˆ›å»ºä¸€ä¸ªè·¯ç”±åŒ¹é…å¯¹è±¡ï¼Œå¹¶ä¸”æ ¹æ® mode æ¥é‡‡å–ä¸åŒçš„è·¯ç”±æ–¹å¼ã€‚</p><h2 id="åˆ›å»ºè·¯ç”±åŒ¹é…å¯¹è±¡">åˆ›å»ºè·¯ç”±åŒ¹é…å¯¹è±¡</h2><div class="language- extra-class"><pre class="language-text"><code>export function createMatcher (
  routes: Array&lt;RouteConfig&gt;,
  router: VueRouter
): Matcher {
    // åˆ›å»ºè·¯ç”±æ˜ å°„è¡¨
  const { pathList, pathMap, nameMap } = createRouteMap(routes)
    
  function addRoutes (routes) {
    createRouteMap(routes, pathList, pathMap, nameMap)
  }
  // è·¯ç”±åŒ¹é…
  function match (
    raw: RawLocation,
    currentRoute?: Route,
    redirectedFrom?: Location
  ): Route {
    //...
  }

  return {
    match,
    addRoutes
  }
}
</code></pre></div><p><code>createMatcher</code> å‡½æ•°çš„ä½œç”¨å°±æ˜¯åˆ›å»ºè·¯ç”±æ˜ å°„è¡¨ï¼Œç„¶åé€šè¿‡é—­åŒ…çš„æ–¹å¼è®© <code>addRoutes</code> å’Œ <code>match</code> å‡½æ•°èƒ½å¤Ÿä½¿ç”¨è·¯ç”±æ˜ å°„è¡¨çš„å‡ ä¸ªå¯¹è±¡ï¼Œæœ€åè¿”å›ä¸€ä¸ª <code>Matcher</code> å¯¹è±¡ã€‚</p><p>æ¥ä¸‹æ¥çœ‹ <code>createMatcher</code> å‡½æ•°æ—¶å¦‚ä½•åˆ›å»ºæ˜ å°„è¡¨çš„</p><div class="language- extra-class"><pre class="language-text"><code>export function createRouteMap (
  routes: Array&lt;RouteConfig&gt;,
  oldPathList?: Array&lt;string&gt;,
  oldPathMap?: Dictionary&lt;RouteRecord&gt;,
  oldNameMap?: Dictionary&lt;RouteRecord&gt;
): {
  pathList: Array&lt;string&gt;;
  pathMap: Dictionary&lt;RouteRecord&gt;;
  nameMap: Dictionary&lt;RouteRecord&gt;;
} {
  // åˆ›å»ºæ˜ å°„è¡¨
  const pathList: Array&lt;string&gt; = oldPathList || []
  const pathMap: Dictionary&lt;RouteRecord&gt; = oldPathMap || Object.create(null)
  const nameMap: Dictionary&lt;RouteRecord&gt; = oldNameMap || Object.create(null)
  // éå†è·¯ç”±é…ç½®ï¼Œä¸ºæ¯ä¸ªé…ç½®æ·»åŠ è·¯ç”±è®°å½•
  routes.forEach(route =&gt; {
    addRouteRecord(pathList, pathMap, nameMap, route)
  })
  // ç¡®ä¿é€šé…ç¬¦åœ¨æœ€å
  for (let i = 0, l = pathList.length; i &lt; l; i++) {
    if (pathList[i] === '*') {
      pathList.push(pathList.splice(i, 1)[0])
      l--
      i--
    }
  }
  return {
    pathList,
    pathMap,
    nameMap
  }
}
// æ·»åŠ è·¯ç”±è®°å½•
function addRouteRecord (
  pathList: Array&lt;string&gt;,
  pathMap: Dictionary&lt;RouteRecord&gt;,
  nameMap: Dictionary&lt;RouteRecord&gt;,
  route: RouteConfig,
  parent?: RouteRecord,
  matchAs?: string
) {
  // è·å¾—è·¯ç”±é…ç½®ä¸‹çš„å±æ€§
  const { path, name } = route
  const pathToRegexpOptions: PathToRegexpOptions = route.pathToRegexpOptions || {}
  // æ ¼å¼åŒ– urlï¼Œæ›¿æ¢ / 
  const normalizedPath = normalizePath(
    path,
    parent,
    pathToRegexpOptions.strict
  )
  // ç”Ÿæˆè®°å½•å¯¹è±¡
  const record: RouteRecord = {
    path: normalizedPath,
    regex: compileRouteRegex(normalizedPath, pathToRegexpOptions),
    components: route.components || { default: route.component },
    instances: {},
    name,
    parent,
    matchAs,
    redirect: route.redirect,
    beforeEnter: route.beforeEnter,
    meta: route.meta || {},
    props: route.props == null
      ? {}
      : route.components
        ? route.props
        : { default: route.props }
  }

  if (route.children) {
    // é€’å½’è·¯ç”±é…ç½®çš„ children å±æ€§ï¼Œæ·»åŠ è·¯ç”±è®°å½•
    route.children.forEach(child =&gt; {
      const childMatchAs = matchAs
        ? cleanPath(`${matchAs}/${child.path}`)
        : undefined
      addRouteRecord(pathList, pathMap, nameMap, child, record, childMatchAs)
    })
  }
  // å¦‚æœè·¯ç”±æœ‰åˆ«åçš„è¯
  // ç»™åˆ«åä¹Ÿæ·»åŠ è·¯ç”±è®°å½•
  if (route.alias !== undefined) {
    const aliases = Array.isArray(route.alias)
      ? route.alias
      : [route.alias]

    aliases.forEach(alias =&gt; {
      const aliasRoute = {
        path: alias,
        children: route.children
      }
      addRouteRecord(
        pathList,
        pathMap,
        nameMap,
        aliasRoute,
        parent,
        record.path || '/' // matchAs
      )
    })
  }
  // æ›´æ–°æ˜ å°„è¡¨
  if (!pathMap[record.path]) {
    pathList.push(record.path)
    pathMap[record.path] = record
  }
  // å‘½åè·¯ç”±æ·»åŠ è®°å½•
  if (name) {
    if (!nameMap[name]) {
      nameMap[name] = record
    } else if (process.env.NODE_ENV !== 'production' &amp;&amp; !matchAs) {
      warn(
        false,
        `Duplicate named routes definition: ` +
        `{ name: &quot;${name}&quot;, path: &quot;${record.path}&quot; }`
      )
    }
  }
}
</code></pre></div><p>ä»¥ä¸Šå°±æ˜¯åˆ›å»ºè·¯ç”±åŒ¹é…å¯¹è±¡çš„å…¨è¿‡ç¨‹ï¼Œé€šè¿‡ç”¨æˆ·é…ç½®çš„è·¯ç”±è§„åˆ™æ¥åˆ›å»ºå¯¹åº”çš„è·¯ç”±æ˜ å°„è¡¨ã€‚</p><h2 id="è·¯ç”±åˆå§‹åŒ–">è·¯ç”±åˆå§‹åŒ–</h2><p>å½“æ ¹ç»„ä»¶è°ƒç”¨ <code>beforeCreate</code> é’©å­å‡½æ•°æ—¶ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹ä»£ç </p><div class="language- extra-class"><pre class="language-text"><code>beforeCreate () {
// åªæœ‰æ ¹ç»„ä»¶æœ‰ router å±æ€§ï¼Œæ‰€ä»¥æ ¹ç»„ä»¶åˆå§‹åŒ–æ—¶ä¼šåˆå§‹åŒ–è·¯ç”±
  if (isDef(this.$options.router)) {
    this._routerRoot = this
    this._router = this.$options.router
    this._router.init(this)
    Vue.util.defineReactive(this, '_route', this._router.history.current)
  } else {
    this._routerRoot = (this.$parent &amp;&amp; this.$parent._routerRoot) || this
  }
  registerInstance(this, this)
}
</code></pre></div><p>æ¥ä¸‹æ¥çœ‹ä¸‹è·¯ç”±åˆå§‹åŒ–ä¼šåšäº›ä»€ä¹ˆ</p><div class="language- extra-class"><pre class="language-text"><code>init(app: any /* Vue component instance */) {
    // ä¿å­˜ç»„ä»¶å®ä¾‹
    this.apps.push(app)
    // å¦‚æœæ ¹ç»„ä»¶å·²ç»æœ‰äº†å°±è¿”å›
    if (this.app) {
      return
    }
    this.app = app
    // èµ‹å€¼è·¯ç”±æ¨¡å¼
    const history = this.history
    // åˆ¤æ–­è·¯ç”±æ¨¡å¼ï¼Œä»¥å“ˆå¸Œæ¨¡å¼ä¸ºä¾‹
    if (history instanceof HTML5History) {
      history.transitionTo(history.getCurrentLocation())
    } else if (history instanceof HashHistory) {
      // æ·»åŠ  hashchange ç›‘å¬
      const setupHashListener = () =&gt; {
        history.setupListeners()
      }
      // è·¯ç”±è·³è½¬
      history.transitionTo(
        history.getCurrentLocation(),
        setupHashListener,
        setupHashListener
      )
    }
    // è¯¥å›è°ƒä¼šåœ¨ transitionTo ä¸­è°ƒç”¨
    // å¯¹ç»„ä»¶çš„ _route å±æ€§è¿›è¡Œèµ‹å€¼ï¼Œè§¦å‘ç»„ä»¶æ¸²æŸ“
    history.listen(route =&gt; {
      this.apps.forEach(app =&gt; {
        app._route = route
      })
    })
  }
</code></pre></div><p>åœ¨è·¯ç”±åˆå§‹åŒ–æ—¶ï¼Œæ ¸å¿ƒå°±æ˜¯è¿›è¡Œè·¯ç”±çš„è·³è½¬ï¼Œæ”¹å˜ URL ç„¶åæ¸²æŸ“å¯¹åº”çš„ç»„ä»¶ã€‚æ¥ä¸‹æ¥æ¥çœ‹ä¸€ä¸‹è·¯ç”±æ˜¯å¦‚ä½•è¿›è¡Œè·³è½¬çš„ã€‚</p><h2 id="è·¯ç”±è·³è½¬">è·¯ç”±è·³è½¬</h2><div class="language- extra-class"><pre class="language-text"><code>transitionTo (location: RawLocation, onComplete?: Function, onAbort?: Function) {
  // è·å–åŒ¹é…çš„è·¯ç”±ä¿¡æ¯
  const route = this.router.match(location, this.current)
  // ç¡®è®¤åˆ‡æ¢è·¯ç”±
  this.confirmTransition(route, () =&gt; {
    // ä»¥ä¸‹ä¸ºåˆ‡æ¢è·¯ç”±æˆåŠŸæˆ–å¤±è´¥çš„å›è°ƒ
    // æ›´æ–°è·¯ç”±ä¿¡æ¯ï¼Œå¯¹ç»„ä»¶çš„ _route å±æ€§è¿›è¡Œèµ‹å€¼ï¼Œè§¦å‘ç»„ä»¶æ¸²æŸ“
    // è°ƒç”¨ afterHooks ä¸­çš„é’©å­å‡½æ•°
    this.updateRoute(route)
    // æ·»åŠ  hashchange ç›‘å¬
    onComplete &amp;&amp; onComplete(route)
    // æ›´æ–° URL
    this.ensureURL()
    // åªæ‰§è¡Œä¸€æ¬¡ ready å›è°ƒ
    if (!this.ready) {
      this.ready = true
      this.readyCbs.forEach(cb =&gt; { cb(route) })
    }
  }, err =&gt; {
  // é”™è¯¯å¤„ç†
    if (onAbort) {
      onAbort(err)
    }
    if (err &amp;&amp; !this.ready) {
      this.ready = true
      this.readyErrorCbs.forEach(cb =&gt; { cb(err) })
    }
  })
}
</code></pre></div><p>åœ¨è·¯ç”±è·³è½¬ä¸­ï¼Œéœ€è¦å…ˆè·å–åŒ¹é…çš„è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥å…ˆæ¥çœ‹ä¸‹å¦‚ä½•è·å–åŒ¹é…çš„è·¯ç”±ä¿¡æ¯</p><div class="language- extra-class"><pre class="language-text"><code>function match (
  raw: RawLocation,
  currentRoute?: Route,
  redirectedFrom?: Location
): Route {
  // åºåˆ—åŒ– url
  // æ¯”å¦‚å¯¹äºè¯¥ url æ¥è¯´ /abc?foo=bar&amp;baz=qux#hello
  // ä¼šåºåˆ—åŒ–è·¯å¾„ä¸º /abc
  // å“ˆå¸Œä¸º #hello
  // å‚æ•°ä¸º foo: 'bar', baz: 'qux'
  const location = normalizeLocation(raw, currentRoute, false, router)
  const { name } = location
  // å¦‚æœæ˜¯å‘½åè·¯ç”±ï¼Œå°±åˆ¤æ–­è®°å½•ä¸­æ˜¯å¦æœ‰è¯¥å‘½åè·¯ç”±é…ç½®
  if (name) {
    const record = nameMap[name]
    // æ²¡æ‰¾åˆ°è¡¨ç¤ºæ²¡æœ‰åŒ¹é…çš„è·¯ç”±
    if (!record) return _createRoute(null, location)
    const paramNames = record.regex.keys
      .filter(key =&gt; !key.optional)
      .map(key =&gt; key.name)
    // å‚æ•°å¤„ç†
    if (typeof location.params !== 'object') {
      location.params = {}
    }
    if (currentRoute &amp;&amp; typeof currentRoute.params === 'object') {
      for (const key in currentRoute.params) {
        if (!(key in location.params) &amp;&amp; paramNames.indexOf(key) &gt; -1) {
          location.params[key] = currentRoute.params[key]
        }
      }
    }
    if (record) {
      location.path = fillParams(record.path, location.params, `named route &quot;${name}&quot;`)
      return _createRoute(record, location, redirectedFrom)
    }
  } else if (location.path) {
    // éå‘½åè·¯ç”±å¤„ç†
    location.params = {}
    for (let i = 0; i &lt; pathList.length; i++) {
     // æŸ¥æ‰¾è®°å½•
      const path = pathList[i]
      const record = pathMap[path]
      // å¦‚æœåŒ¹é…è·¯ç”±ï¼Œåˆ™åˆ›å»ºè·¯ç”±
      if (matchRoute(record.regex, location.path, location.params)) {
        return _createRoute(record, location, redirectedFrom)
      }
    }
  }
  // æ²¡æœ‰åŒ¹é…çš„è·¯ç”±
  return _createRoute(null, location)
}
</code></pre></div><p>æ¥ä¸‹æ¥çœ‹çœ‹å¦‚ä½•åˆ›å»ºè·¯ç”±</p><div class="language- extra-class"><pre class="language-text"><code>// æ ¹æ®æ¡ä»¶åˆ›å»ºä¸åŒçš„è·¯ç”±
function _createRoute(
  record: ?RouteRecord,
  location: Location,
  redirectedFrom?: Location
): Route {
  if (record &amp;&amp; record.redirect) {
    return redirect(record, redirectedFrom || location)
  }
  if (record &amp;&amp; record.matchAs) {
    return alias(record, location, record.matchAs)
  }
  return createRoute(record, location, redirectedFrom, router)
}

export function createRoute (
  record: ?RouteRecord,
  location: Location,
  redirectedFrom?: ?Location,
  router?: VueRouter
): Route {
  const stringifyQuery = router &amp;&amp; router.options.stringifyQuery
  // å…‹éš†å‚æ•°
  let query: any = location.query || {}
  try {
    query = clone(query)
  } catch (e) {}
  // åˆ›å»ºè·¯ç”±å¯¹è±¡
  const route: Route = {
    name: location.name || (record &amp;&amp; record.name),
    meta: (record &amp;&amp; record.meta) || {},
    path: location.path || '/',
    hash: location.hash || '',
    query,
    params: location.params || {},
    fullPath: getFullPath(location, stringifyQuery),
    matched: record ? formatMatch(record) : []
  }
  if (redirectedFrom) {
    route.redirectedFrom = getFullPath(redirectedFrom, stringifyQuery)
  }
  // è®©è·¯ç”±å¯¹è±¡ä¸å¯ä¿®æ”¹
  return Object.freeze(route)
}
// è·å¾—åŒ…å«å½“å‰è·¯ç”±çš„æ‰€æœ‰åµŒå¥—è·¯å¾„ç‰‡æ®µçš„è·¯ç”±è®°å½•
// åŒ…å«ä»æ ¹è·¯ç”±åˆ°å½“å‰è·¯ç”±çš„åŒ¹é…è®°å½•ï¼Œä»ä¸Šè‡³ä¸‹
function formatMatch(record: ?RouteRecord): Array&lt;RouteRecord&gt; {
  const res = []
  while (record) {
    res.unshift(record)
    record = record.parent
  }
  return res
}
</code></pre></div><p>è‡³æ­¤åŒ¹é…è·¯ç”±å·²ç»å®Œæˆï¼Œæˆ‘ä»¬å›åˆ° <code>transitionTo</code> å‡½æ•°ä¸­ï¼Œæ¥ä¸‹æ¥æ‰§è¡Œ <code>confirmTransition</code></p><div class="language- extra-class"><pre class="language-text"><code>transitionTo (location: RawLocation, onComplete?: Function, onAbort?: Function) {
  // ç¡®è®¤åˆ‡æ¢è·¯ç”±
  this.confirmTransition(route, () =&gt; {}
}
confirmTransition(route: Route, onComplete: Function, onAbort?: Function) {
  const current = this.current
  // ä¸­æ–­è·³è½¬è·¯ç”±å‡½æ•°
  const abort = err =&gt; {
    if (isError(err)) {
      if (this.errorCbs.length) {
        this.errorCbs.forEach(cb =&gt; {
          cb(err)
        })
      } else {
        warn(false, 'uncaught error during route navigation:')
        console.error(err)
      }
    }
    onAbort &amp;&amp; onAbort(err)
  }
  // å¦‚æœæ˜¯ç›¸åŒçš„è·¯ç”±å°±ä¸è·³è½¬
  if (
    isSameRoute(route, current) &amp;&amp;
    route.matched.length === current.matched.length
  ) {
    this.ensureURL()
    return abort()
  }
  // é€šè¿‡å¯¹æ¯”è·¯ç”±è§£æå‡ºå¯å¤ç”¨çš„ç»„ä»¶ï¼Œéœ€è¦æ¸²æŸ“çš„ç»„ä»¶ï¼Œå¤±æ´»çš„ç»„ä»¶
  const { updated, deactivated, activated } = resolveQueue(
    this.current.matched,
    route.matched
  )
  
  function resolveQueue(
      current: Array&lt;RouteRecord&gt;,
      next: Array&lt;RouteRecord&gt;
    ): {
      updated: Array&lt;RouteRecord&gt;,
      activated: Array&lt;RouteRecord&gt;,
      deactivated: Array&lt;RouteRecord&gt;
    } {
      let i
      const max = Math.max(current.length, next.length)
      for (i = 0; i &lt; max; i++) {
        // å½“å‰è·¯ç”±è·¯å¾„å’Œè·³è½¬è·¯ç”±è·¯å¾„ä¸åŒæ—¶è·³å‡ºéå†
        if (current[i] !== next[i]) {
          break
        }
      }
      return {
        // å¯å¤ç”¨çš„ç»„ä»¶å¯¹åº”è·¯ç”±
        updated: next.slice(0, i),
        // éœ€è¦æ¸²æŸ“çš„ç»„ä»¶å¯¹åº”è·¯ç”±
        activated: next.slice(i),
        // å¤±æ´»çš„ç»„ä»¶å¯¹åº”è·¯ç”±
        deactivated: current.slice(i)
      }
  }
  // å¯¼èˆªå®ˆå«æ•°ç»„
  const queue: Array&lt;?NavigationGuard&gt; = [].concat(
    // å¤±æ´»çš„ç»„ä»¶é’©å­
    extractLeaveGuards(deactivated),
    // å…¨å±€ beforeEach é’©å­
    this.router.beforeHooks,
    // åœ¨å½“å‰è·¯ç”±æ”¹å˜ï¼Œä½†æ˜¯è¯¥ç»„ä»¶è¢«å¤ç”¨æ—¶è°ƒç”¨
    extractUpdateHooks(updated),
    // éœ€è¦æ¸²æŸ“ç»„ä»¶ enter å®ˆå«é’©å­
    activated.map(m =&gt; m.beforeEnter),
    // è§£æå¼‚æ­¥è·¯ç”±ç»„ä»¶
    resolveAsyncComponents(activated)
  )
  // ä¿å­˜è·¯ç”±
  this.pending = route
  // è¿­ä»£å™¨ï¼Œç”¨äºæ‰§è¡Œ queue ä¸­çš„å¯¼èˆªå®ˆå«é’©å­
  const iterator = (hook: NavigationGuard, next) =&gt; {
  // è·¯ç”±ä¸ç›¸ç­‰å°±ä¸è·³è½¬è·¯ç”±
    if (this.pending !== route) {
      return abort()
    }
    try {
    // æ‰§è¡Œé’©å­
      hook(route, current, (to: any) =&gt; {
        // åªæœ‰æ‰§è¡Œäº†é’©å­å‡½æ•°ä¸­çš„ nextï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªé’©å­å‡½æ•°
        // å¦åˆ™ä¼šæš‚åœè·³è½¬
        // ä»¥ä¸‹é€»è¾‘æ˜¯åœ¨åˆ¤æ–­ next() ä¸­çš„ä¼ å‚
        if (to === false || isError(to)) {
          // next(false) 
          this.ensureURL(true)
          abort(to)
        } else if (
          typeof to === 'string' ||
          (typeof to === 'object' &amp;&amp;
            (typeof to.path === 'string' || typeof to.name === 'string'))
        ) {
        // next('/') æˆ–è€… next({ path: '/' }) -&gt; é‡å®šå‘
          abort()
          if (typeof to === 'object' &amp;&amp; to.replace) {
            this.replace(to)
          } else {
            this.push(to)
          }
        } else {
        // è¿™é‡Œæ‰§è¡Œ next
        // ä¹Ÿå°±æ˜¯æ‰§è¡Œä¸‹é¢å‡½æ•° runQueue ä¸­çš„ step(index + 1)
          next(to)
        }
      })
    } catch (e) {
      abort(e)
    }
  }
  // ç»å…¸çš„åŒæ­¥æ‰§è¡Œå¼‚æ­¥å‡½æ•°
  runQueue(queue, iterator, () =&gt; {
    const postEnterCbs = []
    const isValid = () =&gt; this.current === route
    // å½“æ‰€æœ‰å¼‚æ­¥ç»„ä»¶åŠ è½½å®Œæˆåï¼Œä¼šæ‰§è¡Œè¿™é‡Œçš„å›è°ƒï¼Œä¹Ÿå°±æ˜¯ runQueue ä¸­çš„ cb()
    // æ¥ä¸‹æ¥æ‰§è¡Œ éœ€è¦æ¸²æŸ“ç»„ä»¶çš„å¯¼èˆªå®ˆå«é’©å­
    const enterGuards = extractEnterGuards(activated, postEnterCbs, isValid)
    const queue = enterGuards.concat(this.router.resolveHooks)
    runQueue(queue, iterator, () =&gt; {
    // è·³è½¬å®Œæˆ
      if (this.pending !== route) {
        return abort()
      }
      this.pending = null
      onComplete(route)
      if (this.router.app) {
        this.router.app.$nextTick(() =&gt; {
          postEnterCbs.forEach(cb =&gt; {
            cb()
          })
        })
      }
    })
  })
}
export function runQueue (queue: Array&lt;?NavigationGuard&gt;, fn: Function, cb: Function) {
  const step = index =&gt; {
  // é˜Ÿåˆ—ä¸­çš„å‡½æ•°éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œå°±æ‰§è¡Œå›è°ƒå‡½æ•°
    if (index &gt;= queue.length) {
      cb()
    } else {
      if (queue[index]) {
      // æ‰§è¡Œè¿­ä»£å™¨ï¼Œç”¨æˆ·åœ¨é’©å­å‡½æ•°ä¸­æ‰§è¡Œ next() å›è°ƒ
      // å›è°ƒä¸­åˆ¤æ–­ä¼ å‚ï¼Œæ²¡æœ‰é—®é¢˜å°±æ‰§è¡Œ next()ï¼Œä¹Ÿå°±æ˜¯ fn å‡½æ•°ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°
        fn(queue[index], () =&gt; {
          step(index + 1)
        })
      } else {
        step(index + 1)
      }
    }
  }
  // å–å‡ºé˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªé’©å­å‡½æ•°
  step(0)
}
</code></pre></div><p>æ¥ä¸‹æ¥ä»‹ç»å¯¼èˆªå®ˆå«</p><div class="language- extra-class"><pre class="language-text"><code>const queue: Array&lt;?NavigationGuard&gt; = [].concat(
    // å¤±æ´»çš„ç»„ä»¶é’©å­
    extractLeaveGuards(deactivated),
    // å…¨å±€ beforeEach é’©å­
    this.router.beforeHooks,
    // åœ¨å½“å‰è·¯ç”±æ”¹å˜ï¼Œä½†æ˜¯è¯¥ç»„ä»¶è¢«å¤ç”¨æ—¶è°ƒç”¨
    extractUpdateHooks(updated),
    // éœ€è¦æ¸²æŸ“ç»„ä»¶ enter å®ˆå«é’©å­
    activated.map(m =&gt; m.beforeEnter),
    // è§£æå¼‚æ­¥è·¯ç”±ç»„ä»¶
    resolveAsyncComponents(activated)
)
</code></pre></div><p>ç¬¬ä¸€æ­¥æ˜¯å…ˆæ‰§è¡Œå¤±æ´»ç»„ä»¶çš„é’©å­å‡½æ•°</p><div class="language- extra-class"><pre class="language-text"><code>function extractLeaveGuards(deactivated: Array&lt;RouteRecord&gt;): Array&lt;?Function&gt; {
// ä¼ å…¥éœ€è¦æ‰§è¡Œçš„é’©å­å‡½æ•°å
  return extractGuards(deactivated, 'beforeRouteLeave', bindGuard, true)
}
function extractGuards(
  records: Array&lt;RouteRecord&gt;,
  name: string,
  bind: Function,
  reverse?: boolean
): Array&lt;?Function&gt; {
  const guards = flatMapComponents(records, (def, instance, match, key) =&gt; {
   // æ‰¾å‡ºç»„ä»¶ä¸­å¯¹åº”çš„é’©å­å‡½æ•°
    const guard = extractGuard(def, name)
    if (guard) {
    // ç»™æ¯ä¸ªé’©å­å‡½æ•°æ·»åŠ ä¸Šä¸‹æ–‡å¯¹è±¡ä¸ºç»„ä»¶è‡ªèº«
      return Array.isArray(guard)
        ? guard.map(guard =&gt; bind(guard, instance, match, key))
        : bind(guard, instance, match, key)
    }
  })
  // æ•°ç»„é™ç»´ï¼Œå¹¶ä¸”åˆ¤æ–­æ˜¯å¦éœ€è¦ç¿»è½¬æ•°ç»„
  // å› ä¸ºæŸäº›é’©å­å‡½æ•°éœ€è¦ä»å­æ‰§è¡Œåˆ°çˆ¶
  return flatten(reverse ? guards.reverse() : guards)
}
export function flatMapComponents (
  matched: Array&lt;RouteRecord&gt;,
  fn: Function
): Array&lt;?Function&gt; {
// æ•°ç»„é™ç»´
  return flatten(matched.map(m =&gt; {
  // å°†ç»„ä»¶ä¸­çš„å¯¹è±¡ä¼ å…¥å›è°ƒå‡½æ•°ä¸­ï¼Œè·å¾—é’©å­å‡½æ•°æ•°ç»„
    return Object.keys(m.components).map(key =&gt; fn(
      m.components[key],
      m.instances[key],
      m, key
    ))
  }))
}
</code></pre></div><p>ç¬¬äºŒæ­¥æ‰§è¡Œå…¨å±€ beforeEach é’©å­å‡½æ•°</p><div class="language- extra-class"><pre class="language-text"><code>beforeEach(fn: Function): Function {
    return registerHook(this.beforeHooks, fn)
}
function registerHook(list: Array&lt;any&gt;, fn: Function): Function {
  list.push(fn)
  return () =&gt; {
    const i = list.indexOf(fn)
    if (i &gt; -1) list.splice(i, 1)
  }
}
</code></pre></div><p>åœ¨ VueRouter ç±»ä¸­æœ‰ä»¥ä¸Šä»£ç ï¼Œæ¯å½“ç»™ VueRouter å®ä¾‹æ·»åŠ  beforeEach å‡½æ•°æ—¶å°±ä¼šå°†å‡½æ•° push è¿› beforeHooks ä¸­ã€‚</p><p>ç¬¬ä¸‰æ­¥æ‰§è¡Œ <code>beforeRouteUpdate</code> é’©å­å‡½æ•°ï¼Œè°ƒç”¨æ–¹å¼å’Œç¬¬ä¸€æ­¥ç›¸åŒï¼Œåªæ˜¯ä¼ å…¥çš„å‡½æ•°åä¸åŒï¼Œåœ¨è¯¥å‡½æ•°ä¸­å¯ä»¥è®¿é—®åˆ° <code>this</code> å¯¹è±¡ã€‚</p><p>ç¬¬å››æ­¥æ‰§è¡Œ <code>beforeEnter</code> é’©å­å‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯è·¯ç”±ç‹¬äº«çš„é’©å­å‡½æ•°ã€‚</p><p>ç¬¬äº”æ­¥æ˜¯è§£æå¼‚æ­¥ç»„ä»¶ã€‚</p><div class="language- extra-class"><pre class="language-text"><code>export function resolveAsyncComponents (matched: Array&lt;RouteRecord&gt;): Function {
  return (to, from, next) =&gt; {
    let hasAsync = false
    let pending = 0
    let error = null
    // è¯¥å‡½æ•°ä½œç”¨ä¹‹å‰å·²ç»ä»‹ç»è¿‡äº†
    flatMapComponents(matched, (def, _, match, key) =&gt; {
    // åˆ¤æ–­æ˜¯å¦æ˜¯å¼‚æ­¥ç»„ä»¶
      if (typeof def === 'function' &amp;&amp; def.cid === undefined) {
        hasAsync = true
        pending++
        // æˆåŠŸå›è°ƒ
        // once å‡½æ•°ç¡®ä¿å¼‚æ­¥ç»„ä»¶åªåŠ è½½ä¸€æ¬¡
        const resolve = once(resolvedDef =&gt; {
          if (isESModule(resolvedDef)) {
            resolvedDef = resolvedDef.default
          }
          // åˆ¤æ–­æ˜¯å¦æ˜¯æ„é€ å‡½æ•°
          // ä¸æ˜¯çš„è¯é€šè¿‡ Vue æ¥ç”Ÿæˆç»„ä»¶æ„é€ å‡½æ•°
          def.resolved = typeof resolvedDef === 'function'
            ? resolvedDef
            : _Vue.extend(resolvedDef)
        // èµ‹å€¼ç»„ä»¶
        // å¦‚æœç»„ä»¶å…¨éƒ¨è§£æå®Œæ¯•ï¼Œç»§ç»­ä¸‹ä¸€æ­¥
          match.components[key] = resolvedDef
          pending--
          if (pending &lt;= 0) {
            next()
          }
        })
        // å¤±è´¥å›è°ƒ
        const reject = once(reason =&gt; {
          const msg = `Failed to resolve async component ${key}: ${reason}`
          process.env.NODE_ENV !== 'production' &amp;&amp; warn(false, msg)
          if (!error) {
            error = isError(reason)
              ? reason
              : new Error(msg)
            next(error)
          }
        })
        let res
        try {
        // æ‰§è¡Œå¼‚æ­¥ç»„ä»¶å‡½æ•°
          res = def(resolve, reject)
        } catch (e) {
          reject(e)
        }
        if (res) {
        // ä¸‹è½½å®Œæˆæ‰§è¡Œå›è°ƒ
          if (typeof res.then === 'function') {
            res.then(resolve, reject)
          } else {
            const comp = res.component
            if (comp &amp;&amp; typeof comp.then === 'function') {
              comp.then(resolve, reject)
            }
          }
        }
      }
    })
    // ä¸æ˜¯å¼‚æ­¥ç»„ä»¶ç›´æ¥ä¸‹ä¸€æ­¥
    if (!hasAsync) next()
  }
}
</code></pre></div><p>ä»¥ä¸Šå°±æ˜¯ç¬¬ä¸€ä¸ª <code>runQueue</code> ä¸­çš„é€»è¾‘ï¼Œç¬¬äº”æ­¥å®Œæˆåä¼šæ‰§è¡Œç¬¬ä¸€ä¸ª <code>runQueue</code> ä¸­å›è°ƒå‡½æ•°</p><div class="language- extra-class"><pre class="language-text"><code>// è¯¥å›è°ƒç”¨äºä¿å­˜ `beforeRouteEnter` é’©å­ä¸­çš„å›è°ƒå‡½æ•°
const postEnterCbs = []
const isValid = () =&gt; this.current === route
// beforeRouteEnter å¯¼èˆªå®ˆå«é’©å­
const enterGuards = extractEnterGuards(activated, postEnterCbs, isValid)
// beforeResolve å¯¼èˆªå®ˆå«é’©å­
const queue = enterGuards.concat(this.router.resolveHooks)
runQueue(queue, iterator, () =&gt; {
  if (this.pending !== route) {
    return abort()
  }
  this.pending = null
  // è¿™é‡Œä¼šæ‰§è¡Œ afterEach å¯¼èˆªå®ˆå«é’©å­
  onComplete(route)
  if (this.router.app) {
    this.router.app.$nextTick(() =&gt; {
      postEnterCbs.forEach(cb =&gt; {
        cb()
      })
    })
  }
})
</code></pre></div><p>ç¬¬å…­æ­¥æ˜¯æ‰§è¡Œ <code>beforeRouteEnter</code> å¯¼èˆªå®ˆå«é’©å­ï¼Œ<code>beforeRouteEnter</code> é’©å­ä¸èƒ½è®¿é—® <code>this</code> å¯¹è±¡ï¼Œå› ä¸ºé’©å­åœ¨å¯¼èˆªç¡®è®¤å‰è¢«è°ƒç”¨ï¼Œéœ€è¦æ¸²æŸ“çš„ç»„ä»¶è¿˜æ²¡è¢«åˆ›å»ºã€‚ä½†æ˜¯è¯¥é’©å­å‡½æ•°æ˜¯å”¯ä¸€ä¸€ä¸ªæ”¯æŒåœ¨å›è°ƒä¸­è·å– <code>this</code> å¯¹è±¡çš„å‡½æ•°ï¼Œå›è°ƒä¼šåœ¨è·¯ç”±ç¡®è®¤æ‰§è¡Œã€‚</p><div class="language- extra-class"><pre class="language-text"><code>beforeRouteEnter (to, from, next) {
  next(vm =&gt; {
    // é€šè¿‡ `vm` è®¿é—®ç»„ä»¶å®ä¾‹
  })
}
</code></pre></div><p>ä¸‹é¢æ¥çœ‹çœ‹æ˜¯å¦‚ä½•æ”¯æŒåœ¨å›è°ƒä¸­æ‹¿åˆ° <code>this</code> å¯¹è±¡çš„</p><div class="language- extra-class"><pre class="language-text"><code>function extractEnterGuards(
  activated: Array&lt;RouteRecord&gt;,
  cbs: Array&lt;Function&gt;,
  isValid: () =&gt; boolean
): Array&lt;?Function&gt; {
// è¿™é‡Œå’Œä¹‹å‰è°ƒç”¨å¯¼èˆªå®ˆå«åŸºæœ¬ä¸€è‡´
  return extractGuards(
    activated,
    'beforeRouteEnter',
    (guard, _, match, key) =&gt; {
      return bindEnterGuard(guard, match, key, cbs, isValid)
    }
  )
}
function bindEnterGuard(
  guard: NavigationGuard,
  match: RouteRecord,
  key: string,
  cbs: Array&lt;Function&gt;,
  isValid: () =&gt; boolean
): NavigationGuard {
  return function routeEnterGuard(to, from, next) {
    return guard(to, from, cb =&gt; {
    // åˆ¤æ–­ cb æ˜¯å¦æ˜¯å‡½æ•°
    // æ˜¯çš„è¯å°± push è¿› postEnterCbs
      next(cb)
      if (typeof cb === 'function') {
        cbs.push(() =&gt; {
          // å¾ªç¯ç›´åˆ°æ‹¿åˆ°ç»„ä»¶å®ä¾‹
          poll(cb, match.instances, key, isValid)
        })
      }
    })
  }
}
// è¯¥å‡½æ•°æ˜¯ä¸ºäº†è§£å†³ issus #750
// å½“ router-view å¤–é¢åŒ…è£¹äº† mode ä¸º out-in çš„ transition ç»„ä»¶ 
// ä¼šåœ¨ç»„ä»¶åˆæ¬¡å¯¼èˆªåˆ°æ—¶è·å¾—ä¸åˆ°ç»„ä»¶å®ä¾‹å¯¹è±¡
function poll(
  cb: any, // somehow flow cannot infer this is a function
  instances: Object,
  key: string,
  isValid: () =&gt; boolean
) {
  if (
    instances[key] &amp;&amp;
    !instances[key]._isBeingDestroyed // do not reuse being destroyed instance
  ) {
    cb(instances[key])
  } else if (isValid()) {
  // setTimeout 16ms ä½œç”¨å’Œ nextTick åŸºæœ¬ç›¸åŒ
    setTimeout(() =&gt; {
      poll(cb, instances, key, isValid)
    }, 16)
  }
}
</code></pre></div><p>ç¬¬ä¸ƒæ­¥æ˜¯æ‰§è¡Œ <code>beforeResolve</code> å¯¼èˆªå®ˆå«é’©å­ï¼Œå¦‚æœæ³¨å†Œäº†å…¨å±€ <code>beforeResolve</code> é’©å­å°±ä¼šåœ¨è¿™é‡Œæ‰§è¡Œã€‚</p><p>ç¬¬å…«æ­¥å°±æ˜¯å¯¼èˆªç¡®è®¤ï¼Œè°ƒç”¨ <code>afterEach</code> å¯¼èˆªå®ˆå«é’©å­äº†ã€‚</p><p>ä»¥ä¸Šéƒ½æ‰§è¡Œå®Œæˆåï¼Œä¼šè§¦å‘ç»„ä»¶çš„æ¸²æŸ“</p><div class="language- extra-class"><pre class="language-text"><code>history.listen(route =&gt; {
      this.apps.forEach(app =&gt; {
        app._route = route
      })
})
</code></pre></div><p>ä»¥ä¸Šå›è°ƒä¼šåœ¨ <code>updateRoute</code> ä¸­è°ƒç”¨</p><div class="language- extra-class"><pre class="language-text"><code>updateRoute(route: Route) {
    const prev = this.current
    this.current = route
    this.cb &amp;&amp; this.cb(route)
    this.router.afterHooks.forEach(hook =&gt; {
      hook &amp;&amp; hook(route, prev)
    })
}
</code></pre></div><p>è‡³æ­¤ï¼Œè·¯ç”±è·³è½¬å·²ç»å…¨éƒ¨åˆ†æå®Œæ¯•ã€‚æ ¸å¿ƒå°±æ˜¯åˆ¤æ–­éœ€è¦è·³è½¬çš„è·¯ç”±æ˜¯å¦å­˜åœ¨äºè®°å½•ä¸­ï¼Œç„¶åæ‰§è¡Œå„ç§å¯¼èˆªå®ˆå«å‡½æ•°ï¼Œæœ€åå®Œæˆ URL çš„æ”¹å˜å’Œç»„ä»¶çš„æ¸²æŸ“ã€‚</p><p>Now, let's try it ğŸ‘‰</p></div><div class="page-edit"><!----><div class="last-updated"><span class="prefix">Last Updated: </span><span class="time">9/20/2020, 12:22:33 PM</span></div></div><div class="page-nav"><p class="inner"><span class="prev">
        â† <a href="/Weblog/frames/vue/NextTick.html" class="prev">
          NextTick
        </a></span><span class="next"><a href="/Weblog/frames/vue/ç™»å½•æ‹¦æˆªé€»è¾‘.html">
          ç™»å½•æ‹¦æˆªé€»è¾‘
        </a> â†’
      </span></p></div></div></div></div>
    <script src="/Weblog/assets/js/app.05873600.js" defer></script><script src="/Weblog/assets/js/11.d51cd775.js" defer></script>
  </body>
</html>
